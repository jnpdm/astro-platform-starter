---
import Layout from '../layouts/Layout.astro';
import DocumentationHubWrapper from '../components/documentation/DocumentationHubWrapper';
import { loadDocumentationConfig, loadGatesConfig } from '../utils/configCache';
import type { DocumentationSection } from '../types';

// Load configurations with caching
const documentationConfig = await loadDocumentationConfig();
const gatesConfig = await loadGatesConfig();

// Load documentation sections
const sections: DocumentationSection[] = documentationConfig.sections;

// Organize sections by gate for contextual help
const sectionsByGate = sections.reduce(
    (acc, section) => {
        const gate = section.gate;
        if (!acc[gate]) {
            acc[gate] = [];
        }
        acc[gate].push(section);
        return acc;
    },
    {} as Record<string, DocumentationSection[]>
);

// Gate order for display
const gateOrder = ['pre-contract', 'gate-0', 'gate-1', 'gate-2', 'gate-3', 'post-launch', 'all'];

// Helper function to get gate info
function getGateInfo(gateId: string) {
    return gatesConfig.gates.find((g) => g.id === gateId);
}

// Helper function to get gate label
function getGateLabel(gateId: string): string {
    const labels: Record<string, string> = {
        'pre-contract': 'Pre-Contract',
        'gate-0': 'Gate 0',
        'gate-1': 'Gate 1',
        'gate-2': 'Gate 2',
        'gate-3': 'Gate 3',
        'post-launch': 'Post-Launch',
        all: 'All Gates'
    };
    return labels[gateId] || gateId;
}
---

<Layout title="Documentation - Kuiper Partner Onboarding Hub">
    <div class="py-8">
        <!-- Back Link -->
        <div class="mb-6">
            <a href="/" class="inline-flex items-center text-blue-400 hover:text-blue-300 transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
                Back to Dashboard
            </a>
        </div>

        <!-- Page Header -->
        <div class="mb-8">
            <h1 class="text-4xl font-bold mb-2">Documentation Hub</h1>
            <p class="text-gray-300">Access resources organized by gate, phase, and role to support your onboarding activities.</p>
        </div>

        <!-- Gate Overview Section -->
        <div class="mb-8 bg-gray-800/50 border border-gray-700 rounded-lg p-6">
            <h2 class="text-2xl font-bold mb-4">Onboarding Journey Overview</h2>
            <p class="text-gray-300 mb-6">
                The partner onboarding journey consists of multiple gates, each with specific criteria and documentation. Use the filters below to find
                resources relevant to your current gate and role.
            </p>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                {
                    gateOrder
                        .filter((gateId) => gateId !== 'all')
                        .map((gateId) => {
                            const gateInfo = getGateInfo(gateId);
                            const gateSections = sectionsByGate[gateId] || [];

                            return (
                                <div class="bg-gray-900/50 border border-gray-600 rounded-lg p-4">
                                    <h3 class="font-semibold text-lg mb-2">{gateInfo?.name || getGateLabel(gateId)}</h3>
                                    <p class="text-sm text-gray-400 mb-3">{gateInfo?.description || ''}</p>

                                    {gateInfo?.estimatedWeeks && (
                                        <div class="text-xs text-gray-500 mb-2">
                                            <span class="font-medium">Timeline:</span> {gateInfo.estimatedWeeks}
                                        </div>
                                    )}

                                    {gateInfo?.criteria && gateInfo.criteria.length > 0 && (
                                        <div class="mt-3">
                                            <div class="text-xs font-medium text-gray-400 mb-2">Gate Criteria:</div>
                                            <ul class="space-y-1">
                                                {gateInfo.criteria.slice(0, 3).map((criterion) => (
                                                    <li class="text-xs text-gray-500 flex items-start">
                                                        <span class="text-green-500 mr-1">✓</span>
                                                        <span>{criterion}</span>
                                                    </li>
                                                ))}
                                                {gateInfo.criteria.length > 3 && (
                                                    <li class="text-xs text-gray-500 italic">+{gateInfo.criteria.length - 3} more criteria</li>
                                                )}
                                            </ul>
                                        </div>
                                    )}

                                    <div class="mt-3 text-xs text-gray-500">
                                        <span class="font-medium">{gateSections.length}</span> documentation section
                                        {gateSections.length !== 1 ? 's' : ''} available
                                    </div>
                                </div>
                            );
                        })
                }
            </div>
        </div>

        <!-- Phase-Specific Resources Callout -->
        <div class="mb-8 bg-blue-900/20 border border-blue-700/50 rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-2 flex items-center">
                <svg class="w-5 h-5 mr-2 text-blue-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                Phase-Specific Resources
            </h3>
            <p class="text-sm text-gray-300 mb-3">
                Many gates are divided into phases (e.g., Phase 1A, 1B, 1C for Gate 1). Use the phase filter in the documentation hub below to find resources
                specific to your current phase.
            </p>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-2 text-xs">
                <div class="bg-gray-800/50 rounded px-3 py-2">
                    <span class="font-medium text-gray-300">Gate 1:</span>
                    <span class="text-gray-400"> Phases 1A, 1B, 1C</span>
                </div>
                <div class="bg-gray-800/50 rounded px-3 py-2">
                    <span class="font-medium text-gray-300">Gate 2:</span>
                    <span class="text-gray-400"> Phases 2A, 2B</span>
                </div>
                <div class="bg-gray-800/50 rounded px-3 py-2">
                    <span class="font-medium text-gray-300">Gate 3:</span>
                    <span class="text-gray-400"> Phases 3A, 3B</span>
                </div>
                <div class="bg-gray-800/50 rounded px-3 py-2">
                    <span class="font-medium text-gray-300">Total:</span>
                    <span class="text-gray-400"> 7 phases</span>
                </div>
            </div>
        </div>

        <!-- Contextual Help Section -->
        <div class="mb-8 bg-gray-800/50 border border-gray-700 rounded-lg p-6">
            <h2 class="text-xl font-bold mb-3">Contextual Help by Gate</h2>
            <p class="text-sm text-gray-300 mb-4">
                Each gate has specific criteria that must be met before progression. Below are the key criteria for each gate with links to relevant
                documentation.
            </p>

            <div class="space-y-4">
                {
                    gateOrder
                        .filter((gateId) => gateId !== 'all')
                        .map((gateId) => {
                            const gateInfo = getGateInfo(gateId);
                            if (!gateInfo || !gateInfo.criteria || gateInfo.criteria.length === 0) return null;

                            return (
                                <details class="bg-gray-900/50 border border-gray-600 rounded-lg overflow-hidden">
                                    <summary class="px-4 py-3 cursor-pointer hover:bg-gray-800/50 transition-colors font-medium">
                                        {gateInfo.name} - {gateInfo.criteria.length} Criteria
                                    </summary>
                                    <div class="px-4 py-3 border-t border-gray-700">
                                        <ul class="space-y-2">
                                            {gateInfo.criteria.map((criterion) => (
                                                <li class="flex items-start text-sm">
                                                    <span class="text-green-500 mr-2 mt-0.5">✓</span>
                                                    <span class="text-gray-300">{criterion}</span>
                                                </li>
                                            ))}
                                        </ul>
                                        <div class="mt-4 pt-4 border-t border-gray-700">
                                            <a href={`#${gateId}`} class="text-sm text-blue-400 hover:text-blue-300 font-medium">
                                                View {gateInfo.name} Documentation →
                                            </a>
                                        </div>
                                    </div>
                                </details>
                            );
                        })
                }
            </div>
        </div>

        <!-- Documentation Hub Component -->
        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
            <DocumentationHubWrapper sections={sections} client:load />
        </div>

        <!-- Role-Specific Resources Callout -->
        <div class="mt-8 bg-gray-800/50 border border-gray-700 rounded-lg p-6">
            <h3 class="text-lg font-semibold mb-3">Role-Specific Resources</h3>
            <p class="text-sm text-gray-300 mb-4">
                Documentation is organized by role to help you find resources relevant to your responsibilities. Use the role filter above to see resources for:
            </p>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
                <div class="bg-gray-900/50 border border-gray-600 rounded-lg p-3 text-center">
                    <div class="font-medium text-sm mb-1">PAM</div>
                    <div class="text-xs text-gray-400">Partner Account Manager</div>
                </div>
                <div class="bg-gray-900/50 border border-gray-600 rounded-lg p-3 text-center">
                    <div class="font-medium text-sm mb-1">PDM</div>
                    <div class="text-xs text-gray-400">Partner Development Manager</div>
                </div>
                <div class="bg-gray-900/50 border border-gray-600 rounded-lg p-3 text-center">
                    <div class="font-medium text-sm mb-1">TPM</div>
                    <div class="text-xs text-gray-400">Technical Program Manager</div>
                </div>
                <div class="bg-gray-900/50 border border-gray-600 rounded-lg p-3 text-center">
                    <div class="font-medium text-sm mb-1">PSM</div>
                    <div class="text-xs text-gray-400">Partner Success Manager</div>
                </div>
                <div class="bg-gray-900/50 border border-gray-600 rounded-lg p-3 text-center">
                    <div class="font-medium text-sm mb-1">TAM</div>
                    <div class="text-xs text-gray-400">Technical Account Manager</div>
                </div>
            </div>
        </div>
    </div>
</Layout>
