---
export const prerender = false;

import HubLayout from '../layouts/HubLayout.astro';
import { getUserSession } from '../middleware/auth';
import { getRoleDashboardMessage } from '../utils/rbac';

// Get current user from session
const currentUser = getUserSession();

// Get role-specific dashboard message
const roleDashboardMessage = currentUser ? getRoleDashboardMessage(currentUser.role) : '';

// Check for redirect parameter (user was redirected from protected route)
const redirectParam = Astro.url.searchParams.get('redirect');
const errorParam = Astro.url.searchParams.get('error');
---

<HubLayout title="Dashboard" description="Track partner progress through the gated onboarding journey">
    <div class="py-8">
        <h1 class="text-4xl font-bold mb-2">Partner Onboarding Dashboard</h1>
        <p class="text-gray-300 mb-4">Track partner progress through the gated onboarding journey</p>

        {
            redirectParam && !currentUser && (
                <div class="bg-yellow-900/30 border border-yellow-700 text-yellow-200 px-4 py-3 rounded mb-6">
                    <p class="font-semibold mb-2">Authentication Required</p>
                    <p class="text-sm mb-3">You need to sign in to access that page.</p>
                    <button id="login-button" class="bg-yellow-700 hover:bg-yellow-600 px-4 py-2 rounded text-sm font-medium">
                        Sign In
                    </button>
                </div>
            )
        }

        {
            errorParam === 'access_denied' && (
                <div class="bg-red-900/30 border border-red-700 text-red-200 px-4 py-3 rounded mb-6">
                    <p class="font-semibold mb-1">Access Denied</p>
                    <p class="text-sm">You don't have permission to access that page.</p>
                </div>
            )
        }

        {
            errorParam === 'auth_failed' && (
                <div class="bg-red-900/30 border border-red-700 text-red-200 px-4 py-3 rounded mb-6">
                    <p class="font-semibold mb-1">Authentication Failed</p>
                    <p class="text-sm">There was a problem with authentication. Please try again.</p>
                </div>
            )
        }

        {
            errorParam === 'auth_callback_failed' && (
                <div class="bg-red-900/30 border border-red-700 text-red-200 px-4 py-3 rounded mb-6">
                    <p class="font-semibold mb-1">Login Failed</p>
                    <p class="text-sm">The login process was interrupted. Please try again.</p>
                </div>
            )
        }

        {
            currentUser && (
                <div class="bg-blue-900/30 border border-blue-700 text-blue-200 px-4 py-2 rounded mb-6 text-sm">
                    <span class="font-semibold">{currentUser.role}:</span> {roleDashboardMessage}
                </div>
            )
        }

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-400">Loading partner data...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden bg-red-900/50 border border-red-600 text-red-200 px-4 py-3 rounded mb-6">
            <p id="error-message"></p>
            <button id="retry-button" class="mt-2 bg-red-700 hover:bg-red-600 px-4 py-2 rounded text-sm"> Retry </button>
        </div>

        <!-- Dashboard Content (populated by JavaScript) -->
        <div id="dashboard-content" class="hidden">
            <!-- Quick Stats Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                    <div class="text-gray-400 text-sm font-medium mb-1">Total Partners</div>
                    <div id="total-partners" class="text-3xl font-bold">0</div>
                </div>

                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                    <div class="text-gray-400 text-sm font-medium mb-1">Upcoming Launches</div>
                    <div id="upcoming-launches" class="text-3xl font-bold text-blue-400">0</div>
                    <div class="text-gray-400 text-xs mt-1">Next 60 days</div>
                </div>

                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                    <div class="text-gray-400 text-sm font-medium mb-2">Partners by Gate</div>
                    <div id="partners-by-gate-summary" class="space-y-1">
                        <p class="text-gray-500 text-sm">Loading...</p>
                    </div>
                </div>
            </div>

            <!-- PDM Utilization Section (only visible for PDM users) -->
            <div id="pdm-utilization-section" class="hidden mb-8">
                <div class="bg-gradient-to-r from-blue-900/50 to-purple-900/50 border border-blue-700 rounded-lg p-6">
                    <div class="flex items-center justify-between mb-4">
                        <h2 class="text-2xl font-bold">My Utilization</h2>
                        <div class="flex gap-2">
                            <button id="mode-revenue" class="px-4 py-2 rounded-lg text-sm font-medium bg-blue-600 text-white"> Revenue </button>
                            <button id="mode-count" class="px-4 py-2 rounded-lg text-sm font-medium bg-gray-700 text-gray-300 hover:bg-gray-600">
                                Partner Count
                            </button>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                        <div>
                            <div class="text-gray-400 text-sm font-medium mb-1">Current Value</div>
                            <div id="utilization-current" class="text-3xl font-bold text-blue-400">$0</div>
                        </div>

                        <div>
                            <div class="text-gray-400 text-sm font-medium mb-1">Capacity Target</div>
                            <div id="utilization-target" class="text-3xl font-bold text-gray-300">$0</div>
                        </div>

                        <div>
                            <div class="text-gray-400 text-sm font-medium mb-1">Utilization</div>
                            <div id="utilization-percentage" class="text-3xl font-bold text-green-400">0%</div>
                        </div>
                    </div>

                    <!-- Progress Bar -->
                    <div class="mt-4">
                        <div class="w-full bg-gray-700 rounded-full h-3 overflow-hidden">
                            <div
                                id="utilization-progress-bar"
                                class="h-full bg-gradient-to-r from-blue-500 to-green-500 transition-all duration-500"
                                style="width: 0%"
                            >
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 text-sm text-gray-400">
                        <span id="utilization-partner-count">0 partners</span> assigned to you
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Partners by Gate Section -->
                <div class="lg:col-span-2">
                    <h2 class="text-2xl font-bold mb-4">Partners by Gate</h2>
                    <div id="partners-by-gate-list">
                        <p class="text-gray-500">Loading partners...</p>
                    </div>
                </div>

                <!-- Recent Activity Feed -->
                <div class="lg:col-span-1">
                    <h2 class="text-2xl font-bold mb-4">Recent Activity</h2>
                    <div id="recent-activity">
                        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6 text-center">
                            <p class="text-gray-400">Loading activity...</p>
                        </div>
                    </div>

                    <!-- Quick Links -->
                    <div class="mt-6 bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                        <h3 class="font-semibold mb-3">Quick Links</h3>
                        <div class="space-y-2">
                            <a href="/documentation" class="block text-sm text-blue-400 hover:text-blue-300"> ðŸ“š Documentation Hub </a>
                            <a href="/reports" class="block text-sm text-blue-400 hover:text-blue-300"> ðŸ“Š Reports & Analytics </a>
                            <a href="/partner/new" class="block text-sm text-blue-400 hover:text-blue-300"> âž• Create New Partner </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Handle login button click
        const loginButton = document.getElementById('login-button');
        if (loginButton) {
            loginButton.addEventListener('click', () => {
                if (window.kuiperAuth) {
                    window.kuiperAuth.login();
                }
            });
        }

        // Gate configuration
        const gateOrder = ['pre-contract', 'gate-0', 'gate-1', 'gate-2', 'gate-3', 'post-launch'];
        const gateNames = {
            'pre-contract': 'Pre-Contract',
            'gate-0': 'Gate 0: Kickoff',
            'gate-1': 'Gate 1: Ready to Sell',
            'gate-2': 'Gate 2: Ready to Order',
            'gate-3': 'Gate 3: Ready to Deliver',
            'post-launch': 'Post-Launch'
        };

        // PDM Utilization state
        let currentUtilizationMode = 'revenue';
        const REVENUE_TARGET = 10000000; // $10M default
        const PARTNER_COUNT_TARGET = 10; // 10 partners default

        // Client-side data loading
        async function loadDashboardData() {
            const loadingState = document.getElementById('loading-state');
            const errorState = document.getElementById('error-state');
            const errorMessage = document.getElementById('error-message');
            const dashboardContent = document.getElementById('dashboard-content');

            try {
                // Show loading
                loadingState?.classList.remove('hidden');
                errorState?.classList.add('hidden');
                dashboardContent?.classList.add('hidden');

                // Fetch partner data (include credentials to send cookies)
                const response = await fetch('/api/partners', {
                    credentials: 'same-origin'
                });

                if (!response.ok) {
                    // Handle authentication errors gracefully
                    if (response.status === 401) {
                        // User is not authenticated, show empty dashboard
                        loadingState?.classList.add('hidden');
                        dashboardContent?.classList.remove('hidden');
                        renderDashboard([]);
                        return;
                    }
                    throw new Error(`Failed to load partners: ${response.status} ${response.statusText}`);
                }

                const result = await response.json();

                // Handle the API response format {success: true, data: [...]}
                const partners = result.data || result || [];

                // Hide loading, show content
                loadingState?.classList.add('hidden');
                dashboardContent?.classList.remove('hidden');

                // Render dashboard with partner data
                renderDashboard(partners);

                // Render PDM utilization if user is PDM
                renderPDMUtilization(partners);
            } catch (error) {
                console.error('Error loading dashboard:', error);

                // Show error state
                loadingState?.classList.add('hidden');
                errorState?.classList.remove('hidden');
                if (errorMessage) {
                    errorMessage.textContent = error instanceof Error ? error.message : 'Failed to load partner data';
                }
            }
        }

        function renderDashboard(partners) {
            // Update total partners
            const totalPartnersEl = document.getElementById('total-partners');
            if (totalPartnersEl) {
                totalPartnersEl.textContent = partners.length.toString();
            }

            // Calculate upcoming launches (next 60 days)
            const now = new Date();
            const sixtyDaysFromNow = new Date(now.getTime() + 60 * 24 * 60 * 60 * 1000);
            const upcomingLaunches = partners.filter((p) => {
                if (!p.targetLaunchDate) return false;
                const launchDate = new Date(p.targetLaunchDate);
                return launchDate >= now && launchDate <= sixtyDaysFromNow;
            }).length;

            const upcomingLaunchesEl = document.getElementById('upcoming-launches');
            if (upcomingLaunchesEl) {
                upcomingLaunchesEl.textContent = upcomingLaunches.toString();
            }

            // Group partners by gate
            const partnersByGate = {};
            gateOrder.forEach((gate) => {
                partnersByGate[gate] = [];
            });

            partners.forEach((partner) => {
                const gate = partner.currentGate || 'pre-contract';
                if (partnersByGate[gate]) {
                    partnersByGate[gate].push(partner);
                }
            });

            // Render partners by gate summary
            renderPartnersByGateSummary(partnersByGate);

            // Render partners by gate list
            renderPartnersByGateList(partnersByGate);

            // Render recent activity
            renderRecentActivity(partners);
        }

        function renderPartnersByGateSummary(partnersByGate) {
            const summaryEl = document.getElementById('partners-by-gate-summary');
            if (!summaryEl) return;

            const topGates = gateOrder
                .map((gate) => ({
                    name: gateNames[gate],
                    count: partnersByGate[gate].length
                }))
                .filter((g) => g.count > 0)
                .slice(0, 3);

            if (topGates.length === 0) {
                summaryEl.innerHTML = '<p class="text-gray-500 text-sm">No partners yet</p>';
                return;
            }

            summaryEl.innerHTML = topGates
                .map(
                    ({ name, count }) => `
                <div class="flex justify-between text-sm">
                    <span class="text-gray-300">${name.replace(/^Gate \d+: /, '')}</span>
                    <span class="font-semibold">${count}</span>
                </div>
            `
                )
                .join('');
        }

        function renderPartnersByGateList(partnersByGate) {
            const listEl = document.getElementById('partners-by-gate-list');
            if (!listEl) return;

            const totalPartners = Object.values(partnersByGate).reduce((sum, arr) => sum + arr.length, 0);

            if (totalPartners === 0) {
                listEl.innerHTML = `
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-8 text-center">
                        <p class="text-gray-400 mb-4">No partners found</p>
                        <a href="/partner/new" class="text-blue-400 hover:text-blue-300">
                            Create your first partner
                        </a>
                    </div>
                `;
                return;
            }

            const html = gateOrder
                .map((gateId) => {
                    const gatePartners = partnersByGate[gateId] || [];
                    if (gatePartners.length === 0) return '';

                    const partnersHtml = gatePartners
                        .map((partner) => {
                            const currentGateStatus = partner.gates?.[gateId]?.status || 'not-started';
                            const statusColor = getStatusColor(currentGateStatus);

                            return `
                        <div class="bg-gray-900/50 border border-gray-600 rounded-lg p-4 hover:border-gray-500 transition-colors">
                            <div class="flex items-start justify-between mb-2">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-lg mb-1">
                                        <a href="/partner/${partner.id}" class="hover:text-blue-400 transition-colors">
                                            ${partner.partnerName}
                                        </a>
                                    </h4>
                                    <div class="flex flex-wrap gap-3 text-sm text-gray-400">
                                        <span>PAM: <span class="text-gray-300">${partner.pamOwner}</span></span>
                                        <span>â€¢</span>
                                        <span>Tier: <span class="text-gray-300 uppercase">${partner.tier}</span></span>
                                        ${
                                            partner.targetLaunchDate
                                                ? `
                                            <span>â€¢</span>
                                            <span>Launch: <span class="text-gray-300">${formatDate(partner.targetLaunchDate)}</span></span>
                                        `
                                                : ''
                                        }
                                    </div>
                                </div>
                                <span class="px-3 py-1 rounded-full text-xs font-medium ${statusColor}">
                                    ${currentGateStatus.replace('-', ' ').toUpperCase()}
                                </span>
                            </div>
                        </div>
                    `;
                        })
                        .join('');

                    return `
                    <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6 mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h3 class="text-xl font-semibold">${gateNames[gateId]}</h3>
                            <span class="bg-gray-700 text-gray-300 px-3 py-1 rounded-full text-sm font-medium">
                                ${gatePartners.length} ${gatePartners.length === 1 ? 'partner' : 'partners'}
                            </span>
                        </div>
                        <div class="grid grid-cols-1 gap-4">
                            ${partnersHtml}
                        </div>
                    </div>
                `;
                })
                .join('');

            listEl.innerHTML = html;
        }

        function renderRecentActivity(partners) {
            const activityEl = document.getElementById('recent-activity');
            if (!activityEl) return;

            // For now, show no activity message
            activityEl.innerHTML = `
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6 text-center">
                    <p class="text-gray-400">No recent activity</p>
                </div>
            `;
        }

        function getStatusColor(status) {
            switch (status) {
                case 'passed':
                    return 'bg-green-600';
                case 'in-progress':
                    return 'bg-yellow-600';
                case 'failed':
                    return 'bg-red-600';
                case 'blocked':
                    return 'bg-orange-600';
                default:
                    return 'bg-gray-600';
            }
        }

        function formatDate(date) {
            if (!date) return 'Not set';
            const d = typeof date === 'string' ? new Date(date) : date;
            return d.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }

        function renderPDMUtilization(partners) {
            // Get current user info from the page
            const userRoleElement = document.querySelector('.bg-blue-900\\/30');
            if (!userRoleElement) return;

            const userRoleText = userRoleElement.textContent || '';
            const isPDM = userRoleText.includes('PDM:');

            if (!isPDM) return;

            // Extract PDM email from the role text or use a default
            // In a real implementation, this would come from the session
            const pdmEmail = extractEmailFromSession();
            if (!pdmEmail) return;

            // Show the utilization section
            const utilizationSection = document.getElementById('pdm-utilization-section');
            if (utilizationSection) {
                utilizationSection.classList.remove('hidden');
            }

            // Calculate and display utilization
            updateUtilizationDisplay(partners, pdmEmail);

            // Set up mode toggle buttons
            const revenueButton = document.getElementById('mode-revenue');
            const countButton = document.getElementById('mode-count');

            revenueButton?.addEventListener('click', () => {
                currentUtilizationMode = 'revenue';
                updateModeButtons();
                updateUtilizationDisplay(partners, pdmEmail);
            });

            countButton?.addEventListener('click', () => {
                currentUtilizationMode = 'partner-count';
                updateModeButtons();
                updateUtilizationDisplay(partners, pdmEmail);
            });
        }

        function extractEmailFromSession() {
            // Try to get email from window.kuiperAuth if available
            if (window.kuiperAuth && window.kuiperAuth.user) {
                return window.kuiperAuth.user.email;
            }
            return null;
        }

        function updateModeButtons() {
            const revenueButton = document.getElementById('mode-revenue');
            const countButton = document.getElementById('mode-count');

            if (currentUtilizationMode === 'revenue') {
                revenueButton?.classList.add('bg-blue-600', 'text-white');
                revenueButton?.classList.remove('bg-gray-700', 'text-gray-300');
                countButton?.classList.remove('bg-blue-600', 'text-white');
                countButton?.classList.add('bg-gray-700', 'text-gray-300');
            } else {
                countButton?.classList.add('bg-blue-600', 'text-white');
                countButton?.classList.remove('bg-gray-700', 'text-gray-300');
                revenueButton?.classList.remove('bg-blue-600', 'text-white');
                revenueButton?.classList.add('bg-gray-700', 'text-gray-300');
            }
        }

        function updateUtilizationDisplay(partners, pdmEmail) {
            // Filter partners assigned to this PDM
            const pdmPartners = partners.filter((p) => p.pdmOwner?.toLowerCase() === pdmEmail.toLowerCase());

            let currentValue, capacityTarget, formattedCurrent, formattedTarget;

            if (currentUtilizationMode === 'revenue') {
                // Sum CCV
                currentValue = pdmPartners.reduce((sum, p) => sum + (p.ccv || 0), 0);
                capacityTarget = REVENUE_TARGET;
                formattedCurrent = formatCurrency(currentValue);
                formattedTarget = formatCurrency(capacityTarget);
            } else {
                // Count partners
                currentValue = pdmPartners.length;
                capacityTarget = PARTNER_COUNT_TARGET;
                formattedCurrent = currentValue.toString();
                formattedTarget = capacityTarget.toString();
            }

            // Calculate percentage
            const utilizationPercentage = capacityTarget > 0 ? (currentValue / capacityTarget) * 100 : 0;

            // Update display
            const currentEl = document.getElementById('utilization-current');
            const targetEl = document.getElementById('utilization-target');
            const percentageEl = document.getElementById('utilization-percentage');
            const progressBar = document.getElementById('utilization-progress-bar');
            const partnerCountEl = document.getElementById('utilization-partner-count');

            if (currentEl) currentEl.textContent = formattedCurrent;
            if (targetEl) targetEl.textContent = formattedTarget;
            if (percentageEl) {
                percentageEl.textContent = `${Math.round(utilizationPercentage)}%`;

                // Color code based on utilization
                percentageEl.classList.remove('text-green-400', 'text-yellow-400', 'text-red-400');
                if (utilizationPercentage >= 90) {
                    percentageEl.classList.add('text-red-400');
                } else if (utilizationPercentage >= 70) {
                    percentageEl.classList.add('text-yellow-400');
                } else {
                    percentageEl.classList.add('text-green-400');
                }
            }

            if (progressBar) {
                const cappedPercentage = Math.min(utilizationPercentage, 100);
                progressBar.style.width = `${cappedPercentage}%`;
            }

            if (partnerCountEl) {
                const count = pdmPartners.length;
                partnerCountEl.textContent = `${count} ${count === 1 ? 'partner' : 'partners'}`;
            }
        }

        function formatCurrency(value) {
            if (value >= 1000000) {
                return `$${(value / 1000000).toFixed(1)}M`;
            } else if (value >= 1000) {
                return `$${(value / 1000).toFixed(0)}K`;
            } else {
                return `$${value.toFixed(0)}`;
            }
        }

        // Retry button handler
        document.getElementById('retry-button')?.addEventListener('click', loadDashboardData);

        // Load data on page load
        document.addEventListener('DOMContentLoaded', loadDashboardData);
    </script>
</HubLayout>
