---
export const prerender = false;

import Layout from '../layouts/Layout.astro';
import { getUserSession } from '../middleware/auth';
import { getRoleDashboardMessage } from '../utils/rbac';

// Get current user from session
const currentUser = getUserSession();

// Get role-specific dashboard message
const roleDashboardMessage = currentUser ? getRoleDashboardMessage(currentUser.role) : '';
---

<Layout title="Dashboard - Kuiper Partner Onboarding Hub">
    <div class="py-8">
        <h1 class="text-4xl font-bold mb-2">Partner Onboarding Dashboard</h1>
        <p class="text-gray-300 mb-4">Track partner progress through the gated onboarding journey</p>

        {
            currentUser && (
                <div class="bg-blue-900/30 border border-blue-700 text-blue-200 px-4 py-2 rounded mb-6 text-sm">
                    <span class="font-semibold">{currentUser.role}:</span> {roleDashboardMessage}
                </div>
            )
        }

        <!-- Loading State -->
        <div id="loading-state" class="text-center py-12">
            <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
            <p class="mt-4 text-gray-400">Loading partner data...</p>
        </div>

        <!-- Error State -->
        <div id="error-state" class="hidden bg-red-900/50 border border-red-600 text-red-200 px-4 py-3 rounded mb-6">
            <p id="error-message"></p>
            <button id="retry-button" class="mt-2 bg-red-700 hover:bg-red-600 px-4 py-2 rounded text-sm"> Retry </button>
        </div>

        <!-- Dashboard Content (populated by JavaScript) -->
        <div id="dashboard-content" class="hidden">
            <!-- Quick Stats Section -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                    <div class="text-gray-400 text-sm font-medium mb-1">Total Partners</div>
                    <div class="text-3xl font-bold">{totalPartners}</div>
                </div>

                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                    <div class="text-gray-400 text-sm font-medium mb-1">Upcoming Launches</div>
                    <div class="text-3xl font-bold text-blue-400">{upcomingLaunches}</div>
                    <div class="text-gray-400 text-xs mt-1">Next 60 days</div>
                </div>

                <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                    <div class="text-gray-400 text-sm font-medium mb-2">Partners by Gate</div>
                    <div class="space-y-1">
                        {
                            partnersByGateCount.slice(0, 3).map(({ name, count }) => (
                                <div class="flex justify-between text-sm">
                                    <span class="text-gray-300">{name.replace(/^Gate \d+: /, '')}</span>
                                    <span class="font-semibold">{count}</span>
                                </div>
                            ))
                        }
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                <!-- Partners by Gate Section -->
                <div class="lg:col-span-2">
                    <h2 class="text-2xl font-bold mb-4">Partners by Gate</h2>

                    {
                        totalPartners === 0 ? (
                            <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-8 text-center">
                                <p class="text-gray-400 mb-4">No partners found</p>
                                <a href="/api/partners" class="text-blue-400 hover:text-blue-300">
                                    Create your first partner
                                </a>
                            </div>
                        ) : (
                            <div class="space-y-6">
                                {gateOrder.map((gateId) => {
                                    const gatePartners = partnersByGate[gateId] || [];
                                    const gateInfo = gatesConfig.gates.find((g) => g.id === gateId);

                                    if (gatePartners.length === 0) return null;

                                    return (
                                        <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6">
                                            <div class="flex items-center justify-between mb-4">
                                                <h3 class="text-xl font-semibold">{gateInfo?.name || gateId}</h3>
                                                <span class="bg-gray-700 text-gray-300 px-3 py-1 rounded-full text-sm font-medium">
                                                    {gatePartners.length} {gatePartners.length === 1 ? 'partner' : 'partners'}
                                                </span>
                                            </div>

                                            <div class="grid grid-cols-1 gap-4">
                                                {gatePartners.map((partner) => {
                                                    const currentGateStatus = partner.gates?.[gateId]?.status || 'not-started';

                                                    return (
                                                        <div class="bg-gray-900/50 border border-gray-600 rounded-lg p-4 hover:border-gray-500 transition-colors">
                                                            <div class="flex items-start justify-between mb-2">
                                                                <div class="flex-1">
                                                                    <h4 class="font-semibold text-lg mb-1">
                                                                        <a href={`/partner/${partner.id}`} class="hover:text-blue-400 transition-colors">
                                                                            {partner.partnerName}
                                                                        </a>
                                                                    </h4>
                                                                    <div class="flex flex-wrap gap-3 text-sm text-gray-400">
                                                                        <span>
                                                                            PAM: <span class="text-gray-300">{partner.pamOwner}</span>
                                                                        </span>
                                                                        <span>‚Ä¢</span>
                                                                        <span>
                                                                            Tier: <span class="text-gray-300 uppercase">{partner.tier}</span>
                                                                        </span>
                                                                        {partner.targetLaunchDate && (
                                                                            <>
                                                                                <span>‚Ä¢</span>
                                                                                <span>
                                                                                    Launch:{' '}
                                                                                    <span class="text-gray-300">{formatDate(partner.targetLaunchDate)}</span>
                                                                                </span>
                                                                            </>
                                                                        )}
                                                                    </div>
                                                                </div>
                                                                <span class={`px-3 py-1 rounded-full text-xs font-medium ${getStatusColor(currentGateStatus)}`}>
                                                                    {currentGateStatus.replace('-', ' ').toUpperCase()}
                                                                </span>
                                                            </div>

                                                            {partner.gates?.[gateId]?.blockers && partner.gates[gateId].blockers!.length > 0 && (
                                                                <div class="mt-2 text-sm text-orange-400">
                                                                    ‚ö†Ô∏è {partner.gates[gateId].blockers!.length} blocker(s)
                                                                </div>
                                                            )}
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    );
                                })}
                            </div>
                        )
                    }
                </div>

                <!-- Recent Activity Feed -->
                <div class="lg:col-span-1">
                    <h2 class="text-2xl font-bold mb-4">Recent Activity</h2>

                    {
                        recentActivity.length === 0 ? (
                            <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-6 text-center">
                                <p class="text-gray-400">No recent activity</p>
                            </div>
                        ) : (
                            <div class="bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                                <div class="space-y-4">
                                    {recentActivity.map((activity) => (
                                        <div class="border-b border-gray-700 last:border-b-0 pb-4 last:pb-0">
                                            <div class="flex items-start gap-3">
                                                <div class="flex-shrink-0 w-2 h-2 bg-blue-500 rounded-full mt-2" />
                                                <div class="flex-1 min-w-0">
                                                    <p class="text-sm text-gray-300">
                                                        <a href={`/partner/${activity.partnerId}`} class="font-medium hover:text-blue-400">
                                                            {activity.partnerName}
                                                        </a>
                                                    </p>
                                                    <p class="text-sm text-gray-400 mt-1">{activity.description}</p>
                                                    <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                                                        <span>{activity.actor}</span>
                                                        <span>‚Ä¢</span>
                                                        <span>{getRelativeTime(activity.timestamp)}</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            </div>
                        )
                    }

                    <!-- Quick Links -->
                    <div class="mt-6 bg-gray-800/50 border border-gray-700 rounded-lg p-4">
                        <h3 class="font-semibold mb-3">Quick Links</h3>
                        <div class="space-y-2">
                            <a href="/documentation" class="block text-sm text-blue-400 hover:text-blue-300"> üìö Documentation Hub </a>
                            <a href="/reports" class="block text-sm text-blue-400 hover:text-blue-300"> üìä Reports & Analytics </a>
                            <a href="/api/partners" class="block text-sm text-blue-400 hover:text-blue-300"> ‚ûï Create New Partner </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- End Dashboard Content -->
</Layout>

<script>
    // Client-side data loading
    async function loadDashboardData() {
        const loadingState = document.getElementById('loading-state');
        const errorState = document.getElementById('error-state');
        const errorMessage = document.getElementById('error-message');
        const dashboardContent = document.getElementById('dashboard-content');

        try {
            // Show loading
            loadingState?.classList.remove('hidden');
            errorState?.classList.add('hidden');
            dashboardContent?.classList.add('hidden');

            // Fetch partner data
            const response = await fetch('/api/partners');

            if (!response.ok) {
                throw new Error(`Failed to load partners: ${response.status} ${response.statusText}`);
            }

            const result = await response.json();

            // Handle the API response format {success: true, data: [...]}
            const partners = result.data || result || [];

            // Hide loading, show content
            loadingState?.classList.add('hidden');
            dashboardContent?.classList.remove('hidden');

            // Render dashboard with partner data
            renderDashboard(partners);
        } catch (error) {
            console.error('Error loading dashboard:', error);

            // Show error state
            loadingState?.classList.add('hidden');
            errorState?.classList.remove('hidden');
            if (errorMessage) {
                errorMessage.textContent = error instanceof Error ? error.message : 'Failed to load partner data';
            }
        }
    }

    function renderDashboard(partners) {
        // This is a simplified version - the full dashboard rendering would go here
        // For now, just update the stats
        const totalPartnersEl = document.querySelector('[data-stat="total-partners"]');
        if (totalPartnersEl) {
            totalPartnersEl.textContent = partners.length.toString();
        }

        // Group partners by gate
        const partnersByGate = partners.reduce((acc, partner) => {
            const gate = partner.currentGate || 'pre-contract';
            if (!acc[gate]) acc[gate] = [];
            acc[gate].push(partner);
            return acc;
        }, {});

        // Render partners in each gate section
        // (This would be expanded to render the full UI)
        console.log('Partners by gate:', partnersByGate);
    }

    // Retry button handler
    document.getElementById('retry-button')?.addEventListener('click', loadDashboardData);

    // Load data on page load
    document.addEventListener('DOMContentLoaded', loadDashboardData);
</script>
