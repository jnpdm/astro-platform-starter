---
import '../../src/styles/globals.css';
import '@fontsource-variable/inter/wght.css';
import interWoff2 from '@fontsource-variable/inter/files/inter-latin-wght-normal.woff2?url';
import Header from '../components/Header.astro';
import Navigation from '../components/Navigation.astro';
import Footer from '../components/Footer.astro';

interface Props {
    title: string;
    description?: string;
}

const { title, description } = Astro.props;
const pageTitle = `${title} | Kuiper Partner Onboarding Hub`;
---

<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <title>{pageTitle}</title>
        <meta name="viewport" content="width=device-width" />
        <meta name="generator" content={Astro.generator} />
        {description && <meta name="description" content={description} />}
        <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
        <link rel="preload" as="font" type="font/woff2" href={interWoff2} crossorigin />
    </head>
    <body class="antialiased text-white bg-kuiper-dark">
        <div class="hub-container">
            <div class="hub-wrapper">
                <Header />

                <div class="navigation-wrapper">
                    <Navigation />
                </div>

                <main class="main-content">
                    <slot />
                </main>

                <Footer />
            </div>
        </div>

        <!-- Auth0 initialization and authentication logic -->
        <script>
            import { storeUserSession, clearUserSession, isProtectedRoute, getLoginRedirectUrl, getUserSession } from '../middleware/auth';
            import {
                createAuth0Client,
                login as auth0Login,
                logout as auth0Logout,
                handleCallback as auth0HandleCallback,
                getUser as auth0GetUser,
                isAuthenticated as auth0IsAuthenticated
            } from '../utils/auth0';

            // Check if Auth0 is configured
            function isAuth0Configured(): boolean {
                return !!(import.meta.env.PUBLIC_AUTH0_DOMAIN && import.meta.env.PUBLIC_AUTH0_CLIENT_ID && import.meta.env.PUBLIC_AUTH0_CALLBACK_URL);
            }

            // Mock authentication for development when Auth0 is not configured
            function createMockAuth() {
                console.warn('⚠️  Auth0 not configured - using mock authentication for development');
                console.warn('⚠️  Set PUBLIC_AUTH0_DOMAIN, PUBLIC_AUTH0_CLIENT_ID, and PUBLIC_AUTH0_CALLBACK_URL to use real Auth0');

                const mockUser = {
                    id: 'mock-user-123',
                    email: 'dev@example.com',
                    name: 'Development User',
                    role: 'Admin' as const
                };

                // Store mock user session
                storeUserSession(mockUser);

                return {
                    login: () => {
                        console.log('Mock login - reloading page');
                        storeUserSession(mockUser);
                        window.location.reload();
                    },
                    logout: () => {
                        console.log('Mock logout');
                        clearUserSession();
                        window.location.href = '/';
                    },
                    getCurrentUser: () => mockUser,
                    isAuthenticated: () => true
                };
            }

            // Initialize Auth0 authentication
            async function initializeAuth0() {
                try {
                    console.log('Starting Auth0 initialization...');

                    // Check if Auth0 is configured
                    if (!isAuth0Configured()) {
                        console.log('Auth0 not configured, checking environment...');
                        // Use mock authentication in development
                        if (import.meta.env.DEV) {
                            console.log('Development mode: using mock authentication');
                            const mockAuth = createMockAuth();
                            window.kuiperAuth = mockAuth;
                            isInitialized = true;
                            return;
                        } else {
                            console.error('Auth0 configuration missing. Please set environment variables.');
                            console.error('Required: PUBLIC_AUTH0_DOMAIN, PUBLIC_AUTH0_CLIENT_ID, PUBLIC_AUTH0_CALLBACK_URL');
                            isInitialized = true; // Mark as "initialized" even on error
                            return;
                        }
                    }

                    console.log('Auth0 configured, initializing client...');

                    // Create Auth0 client
                    await createAuth0Client();

                    // Check if we're handling a callback
                    const query = window.location.search;
                    if (query.includes('code=') && query.includes('state=')) {
                        console.log('Handling Auth0 callback...');

                        try {
                            const result = await auth0HandleCallback();

                            // Get the authenticated user
                            const user = await auth0GetUser();

                            if (user) {
                                console.log('User authenticated:', user.email);
                                storeUserSession(user);

                                // Dispatch auth state change event
                                window.dispatchEvent(new CustomEvent('auth-state-changed'));

                                // Redirect to return URL or home
                                const returnTo = result.returnTo || '/';
                                window.location.href = returnTo;
                            } else {
                                console.error('No user returned after callback');
                                window.location.href = '/';
                            }

                            return; // Exit early, we're redirecting
                        } catch (callbackError) {
                            console.error('Callback handling failed:', callbackError);
                            // Clear any partial session data
                            clearUserSession();
                            // Redirect to home with error
                            window.location.href = '/?error=auth_callback_failed';
                            return;
                        }
                    }

                    // Check if user is already authenticated
                    const authenticated = await auth0IsAuthenticated();

                    if (authenticated) {
                        const user = await auth0GetUser();
                        if (user) {
                            console.log('User session restored:', user.email);
                            storeUserSession(user);

                            // Check if we're on a protected route and need to refresh for server-side middleware
                            const currentPath = window.location.pathname;
                            const isProtected = isProtectedRoute(currentPath);

                            if (isProtected) {
                                // Check if cookies are already set (to avoid infinite refresh)
                                const hasCookies = document.cookie.includes('kuiper_user=');

                                if (!hasCookies) {
                                    console.log('Protected route detected, refreshing to ensure server-side session...');
                                    // Small delay to ensure cookies are set
                                    setTimeout(() => {
                                        window.location.reload();
                                    }, 100);
                                    return;
                                }
                            }

                            // Dispatch auth state change event
                            window.dispatchEvent(new CustomEvent('auth-state-changed'));
                        }
                    }
                    // Note: Route protection is now handled by server-side middleware
                    // The middleware will redirect to login before the page renders

                    console.log('Auth0 initialization complete');
                    isInitialized = true;
                } catch (error) {
                    console.error('Auth0 initialization failed:', error);
                    isInitialized = true; // Mark as initialized even on error to prevent hanging

                    // If we're on a protected route and auth failed, redirect to home
                    const currentPath = window.location.pathname;
                    if (isProtectedRoute(currentPath)) {
                        console.log('Authentication required but failed, redirecting to home...');
                        window.location.href = '/?error=auth_failed';
                    }
                }
            }

            // Track initialization state
            let isInitialized = false;
            let initializationPromise: Promise<void> | null = null;

            // Ensure Auth0 is initialized before performing actions
            async function ensureInitialized(): Promise<void> {
                if (isInitialized) return;
                if (initializationPromise) {
                    await initializationPromise;
                    return;
                }
                // If not initialized and no promise, wait a bit and check again
                await new Promise((resolve) => setTimeout(resolve, 100));
                if (!isInitialized) {
                    throw new Error('Auth0 initialization is taking longer than expected. Please refresh the page.');
                }
            }

            // Global authentication functions (available immediately)
            window.kuiperAuth = {
                login: async () => {
                    try {
                        console.log('Initiating login...');
                        await ensureInitialized();
                        // Check if there's a redirect parameter in the URL
                        const urlParams = new URLSearchParams(window.location.search);
                        const redirectPath = urlParams.get('redirect');
                        const returnTo = redirectPath || window.location.pathname;
                        await auth0Login(returnTo);
                    } catch (error) {
                        console.error('Login failed:', error);
                        alert(`Login failed: ${error instanceof Error ? error.message : 'Please try again.'}`);
                    }
                },
                logout: async () => {
                    try {
                        console.log('Logging out...');
                        await ensureInitialized();
                        await auth0Logout();
                    } catch (error) {
                        console.error('Logout failed:', error);
                        // Even if Auth0 logout fails, clear local session and redirect
                        clearUserSession();
                        window.location.href = '/';
                    }
                },
                getCurrentUser: () => {
                    // Return user from session storage (synchronous)
                    return getUserSession();
                },
                isAuthenticated: () => {
                    // Check if user exists in session storage (synchronous)
                    const user = getUserSession();
                    return user !== null;
                }
            };

            // Start initialization when DOM is ready
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => {
                    initializationPromise = initializeAuth0();
                });
            } else {
                initializationPromise = initializeAuth0();
            }
        </script>
    </body>
</html>

<style>
    .hub-container {
        display: flex;
        flex-direction: column;
        min-height: 100vh;
        padding-left: 1.5rem;
        padding-right: 1.5rem;
        background-image: var(--background-image-noise);
        background-size:
            auto,
            200px 200px;
    }

    .hub-wrapper {
        display: flex;
        flex-direction: column;
        width: 100%;
        max-width: 80rem;
        margin-left: auto;
        margin-right: auto;
        flex-grow: 1;
    }

    .navigation-wrapper {
        padding-top: 1rem;
        padding-bottom: 2rem;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        margin-bottom: 2rem;
    }

    .main-content {
        flex-grow: 1;
        padding-bottom: 2rem;
    }

    @media (min-width: 640px) {
        .hub-container {
            padding-left: 3rem;
            padding-right: 3rem;
        }

        .navigation-wrapper {
            padding-bottom: 2.5rem;
            margin-bottom: 2.5rem;
        }

        .main-content {
            padding-bottom: 3rem;
        }
    }
</style>
